<main class="layout">
  <div class="tabs">
    <button type="button" [class.active]="mode() === 'log'" (click)="switchMode('log')">
      Registrar
    </button>
    <button type="button" [class.active]="mode() === 'history'" (click)="switchMode('history')">
      Historial
    </button>
  </div>

  <section *ngIf="mode() === 'log'" class="stack">
    <div class="log-card" #logFormRef>
      <div class="log-card__head">
        <p class="pill current" *ngIf="selectedExerciseName(); else pickOne">
          Registrando: <strong>{{ selectedExerciseName() }}</strong>
        </p>
        <ng-template #pickOne></ng-template>
      </div>
      <mg-training-form
        [exercises]="exercises()"
        [selectedExerciseId]="selectedExerciseId()"
        (saveEntry)="handleSaveEntry($event)"
      />
    </div>
    <section class="routine">
      <h2>Rutina Push / Pull / Legs (intacto)</h2>
      <p class="note">Pulsa “Anotar peso” en cada ejercicio y luego ajusta peso/reps.</p>

      <ng-container *ngFor="let day of routine; trackBy: trackDay">
        <details [attr.open]="day.key === 'push' ? '' : null">
          <summary>{{ day.icon }} {{ day.title }}</summary>
          <article>
            <h3>Calentamiento</h3>
            <ul>
              <li *ngFor="let warm of day.warmup">{{ warm }}</li>
            </ul>

            <h3>Entrenamiento</h3>
            <ol>
              <li class="routine-row" *ngFor="let item of day.training; trackBy: trackExercise">
                <div>
                  <span class="exercise-name">{{ item.name }}</span>
                  <span class="exercise-detail"> — {{ item.detail }}</span>
                </div>
                <button
                  type="button"
                  class="log-btn"
                  (click)="handleQuickLog(item.name, item.muscleGroup)"
                >
                  Anotar peso
                </button>
              </li>
            </ol>

            <ng-container *ngIf="day.finish?.length">
              <h3>Final</h3>
              <ul>
                <li *ngFor="let fin of day.finish">{{ fin }}</li>
              </ul>
            </ng-container>
          </article>
        </details>
      </ng-container>
    </section>
  </section>

  <section *ngIf="mode() === 'history'" class="history-page">
    <h2>Ejercicios y su historial</h2>
    <p class="note">Toca un ejercicio para ver sus registros en tabla.</p>

    <div class="exercise-grid">
      <button
        type="button"
        class="exercise-chip"
        *ngFor="let ex of historyExercises()"
        [class.active]="historyExerciseId() === ex.id"
        (click)="handleSelectHistoryExercise(ex.id)"
      >
        {{ ex.name }}
      </button>
    </div>

    <div class="table-wrapper" *ngIf="historyExerciseId(); else pickExercise">
      <table class="history-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Peso (kg)</th>
            <th>Reps</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let entry of historyEntries()">
            <td>{{ entry.date | date : 'dd/MM/yyyy' }}</td>
            <td>{{ entry.weight }}</td>
            <td>{{ entry.reps ?? '-' }}</td>
          </tr>
          <tr *ngIf="!historyEntries().length">
            <td colspan="3" class="empty">Sin registros aún.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <ng-template #pickExercise>
      <p class="empty">Elige un ejercicio para ver su historial.</p>
    </ng-template>
  </section>
</main>
